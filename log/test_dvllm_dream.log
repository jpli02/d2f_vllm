LoRA Config Loaded: {'alpha_pattern': {}, 'auto_mapping': {'base_model_class': 'DreamModel', 'parent_library': 'transformers_modules.Dream-v0-Base-7B.modeling_dream'}, 'base_model_name_or_path': '/home/wx/data/model/Dream-org/Dream-v0-Base-7B', 'bias': 'none', 'corda_config': None, 'eva_config': None, 'exclude_modules': None, 'fan_in_fan_out': False, 'inference_mode': True, 'init_lora_weights': True, 'layer_replication': None, 'layers_pattern': None, 'layers_to_transform': None, 'loftq_config': {}, 'lora_alpha': 32, 'lora_bias': False, 'lora_dropout': 0.1, 'megatron_config': None, 'megatron_core': 'megatron.core', 'modules_to_save': None, 'peft_type': 'LORA', 'r': 32, 'rank_pattern': {}, 'revision': None, 'target_modules': ['k_proj', 'v_proj', 'q_proj', 'o_proj'], 'task_type': None, 'trainable_token_indices': None, 'use_dora': False, 'use_rslora': False}
Loading base model:   0%|          | 0/4 [00:00<?, ?it/s]Loading base model:  25%|██▌       | 1/4 [00:00<00:01,  2.04it/s]Loading base model:  50%|█████     | 2/4 [00:00<00:00,  3.70it/s]Loading base model:  75%|███████▌  | 3/4 [00:01<00:00,  2.82it/s]Loading base model: 100%|██████████| 4/4 [00:01<00:00,  2.73it/s]Loading base model: 100%|██████████| 4/4 [00:01<00:00,  2.77it/s]
Loading LoRA weights from lora_weight
Loading LoRA:   0%|          | 0/1 [00:00<?, ?it/s]Loading LoRA: 100%|██████████| 1/1 [00:00<00:00, 68.26it/s]
LoRA weights applied to 112 layers and merged
Generating:   0%|          | 0/20 [00:00<?, ?it/s]Generating:   0%|          | 0/20 [00:02<?, ?it/s, Prefill=293tok/s, Decode=0tok/s]Generating:   0%|          | 0/20 [00:03<?, ?it/s, Prefill=293tok/s, Decode=68tok/s]Generating:   0%|          | 0/20 [00:04<?, ?it/s, Prefill=293tok/s, Decode=171tok/s]Generating:   0%|          | 0/20 [00:04<?, ?it/s, Prefill=293tok/s, Decode=88tok/s] Generating:   0%|          | 0/20 [00:04<?, ?it/s, Prefill=293tok/s, Decode=87tok/s]Generating:   0%|          | 0/20 [00:04<?, ?it/s, Prefill=293tok/s, Decode=111tok/s]Generating:   0%|          | 0/20 [00:05<?, ?it/s, Prefill=293tok/s, Decode=131tok/s]Generating:   0%|          | 0/20 [00:05<?, ?it/s, Prefill=293tok/s, Decode=87tok/s] Generating:   0%|          | 0/20 [00:05<?, ?it/s, Prefill=293tok/s, Decode=187tok/s]Generating:   0%|          | 0/20 [00:05<?, ?it/s, Prefill=293tok/s, Decode=189tok/s]Generating:   0%|          | 0/20 [00:06<?, ?it/s, Prefill=293tok/s, Decode=74tok/s] Generating:   0%|          | 0/20 [00:06<?, ?it/s, Prefill=293tok/s, Decode=88tok/s]Generating:   0%|          | 0/20 [00:06<?, ?it/s, Prefill=293tok/s, Decode=64tok/s]Generating:   0%|          | 0/20 [00:07<?, ?it/s, Prefill=293tok/s, Decode=67tok/s]Generating:   0%|          | 0/20 [00:07<?, ?it/s, Prefill=293tok/s, Decode=71tok/s]Generating:   0%|          | 0/20 [00:07<?, ?it/s, Prefill=293tok/s, Decode=153tok/s]Generating:   0%|          | 0/20 [00:08<?, ?it/s, Prefill=293tok/s, Decode=77tok/s] Generating:   0%|          | 0/20 [00:08<?, ?it/s, Prefill=293tok/s, Decode=98tok/s]Generating:   0%|          | 0/20 [00:08<?, ?it/s, Prefill=293tok/s, Decode=141tok/s]Generating:   0%|          | 0/20 [00:08<?, ?it/s, Prefill=293tok/s, Decode=136tok/s]Generating:   0%|          | 0/20 [00:09<?, ?it/s, Prefill=293tok/s, Decode=114tok/s]Generating:   0%|          | 0/20 [00:09<?, ?it/s, Prefill=293tok/s, Decode=115tok/s]Generating:   0%|          | 0/20 [00:09<?, ?it/s, Prefill=293tok/s, Decode=104tok/s]Generating:   0%|          | 0/20 [00:09<?, ?it/s, Prefill=293tok/s, Decode=86tok/s] Generating:   0%|          | 0/20 [00:10<?, ?it/s, Prefill=293tok/s, Decode=131tok/s]Generating:   0%|          | 0/20 [00:10<?, ?it/s, Prefill=293tok/s, Decode=107tok/s]Generating:   0%|          | 0/20 [00:10<?, ?it/s, Prefill=293tok/s, Decode=156tok/s]Generating:   0%|          | 0/20 [00:11<?, ?it/s, Prefill=293tok/s, Decode=99tok/s] Generating:   0%|          | 0/20 [00:11<?, ?it/s, Prefill=293tok/s, Decode=143tok/s]Generating:   0%|          | 0/20 [00:11<?, ?it/s, Prefill=293tok/s, Decode=103tok/s]Generating:   0%|          | 0/20 [00:12<?, ?it/s, Prefill=293tok/s, Decode=78tok/s] Generating:   0%|          | 0/20 [00:12<?, ?it/s, Prefill=293tok/s, Decode=81tok/s]Generating:   0%|          | 0/20 [00:12<?, ?it/s, Prefill=293tok/s, Decode=66tok/s]Generating:   0%|          | 0/20 [00:13<?, ?it/s, Prefill=293tok/s, Decode=122tok/s]Generating:   0%|          | 0/20 [00:13<?, ?it/s, Prefill=293tok/s, Decode=104tok/s]Generating:   0%|          | 0/20 [00:13<?, ?it/s, Prefill=293tok/s, Decode=123tok/s]Generating:   0%|          | 0/20 [00:14<?, ?it/s, Prefill=293tok/s, Decode=85tok/s] Generating:   0%|          | 0/20 [00:14<?, ?it/s, Prefill=293tok/s, Decode=77tok/s]Generating:   0%|          | 0/20 [00:14<?, ?it/s, Prefill=293tok/s, Decode=63tok/s]Generating:   0%|          | 0/20 [00:15<?, ?it/s, Prefill=293tok/s, Decode=71tok/s]Generating:   0%|          | 0/20 [00:15<?, ?it/s, Prefill=293tok/s, Decode=73tok/s]Generating:   0%|          | 0/20 [00:15<?, ?it/s, Prefill=293tok/s, Decode=56tok/s]Generating:   0%|          | 0/20 [00:16<?, ?it/s, Prefill=293tok/s, Decode=112tok/s]Generating:   0%|          | 0/20 [00:16<?, ?it/s, Prefill=293tok/s, Decode=142tok/s]Generating:   0%|          | 0/20 [00:16<?, ?it/s, Prefill=293tok/s, Decode=112tok/s]Generating:   0%|          | 0/20 [00:16<?, ?it/s, Prefill=293tok/s, Decode=58tok/s] Generating:   0%|          | 0/20 [00:17<?, ?it/s, Prefill=293tok/s, Decode=107tok/s]Generating:   0%|          | 0/20 [00:17<?, ?it/s, Prefill=293tok/s, Decode=89tok/s] Generating:   0%|          | 0/20 [00:17<?, ?it/s, Prefill=293tok/s, Decode=106tok/s]Generating:   0%|          | 0/20 [00:18<?, ?it/s, Prefill=293tok/s, Decode=94tok/s] Generating:   0%|          | 0/20 [00:18<?, ?it/s, Prefill=293tok/s, Decode=125tok/s]Generating:   0%|          | 0/20 [00:18<?, ?it/s, Prefill=293tok/s, Decode=69tok/s] Generating:   0%|          | 0/20 [00:19<?, ?it/s, Prefill=293tok/s, Decode=107tok/s]Generating:   0%|          | 0/20 [00:19<?, ?it/s, Prefill=293tok/s, Decode=104tok/s]Generating:   0%|          | 0/20 [00:19<?, ?it/s, Prefill=293tok/s, Decode=65tok/s] Generating:   0%|          | 0/20 [00:20<?, ?it/s, Prefill=293tok/s, Decode=104tok/s]Generating:   0%|          | 0/20 [00:20<?, ?it/s, Prefill=293tok/s, Decode=65tok/s] Generating:   0%|          | 0/20 [00:20<?, ?it/s, Prefill=293tok/s, Decode=55tok/s]Generating:   0%|          | 0/20 [00:21<?, ?it/s, Prefill=293tok/s, Decode=74tok/s]Generating:   0%|          | 0/20 [00:21<?, ?it/s, Prefill=293tok/s, Decode=63tok/s]Generating:   0%|          | 0/20 [00:22<?, ?it/s, Prefill=293tok/s, Decode=88tok/s]Generating:   0%|          | 0/20 [00:22<?, ?it/s, Prefill=293tok/s, Decode=72tok/s]Generating:   0%|          | 0/20 [00:22<?, ?it/s, Prefill=293tok/s, Decode=71tok/s]Generating:   0%|          | 0/20 [00:23<?, ?it/s, Prefill=293tok/s, Decode=91tok/s]Generating:   0%|          | 0/20 [00:23<?, ?it/s, Prefill=293tok/s, Decode=152tok/s]Generating:   0%|          | 0/20 [00:23<?, ?it/s, Prefill=293tok/s, Decode=77tok/s] Generating:   0%|          | 0/20 [00:24<?, ?it/s, Prefill=293tok/s, Decode=156tok/s]Generating:   0%|          | 0/20 [00:24<?, ?it/s, Prefill=293tok/s, Decode=96tok/s] Generating:   0%|          | 0/20 [00:25<?, ?it/s, Prefill=293tok/s, Decode=128tok/s]Generating:   0%|          | 0/20 [00:25<?, ?it/s, Prefill=293tok/s, Decode=98tok/s] Generating:   0%|          | 0/20 [00:26<?, ?it/s, Prefill=293tok/s, Decode=41tok/s]Generating:   0%|          | 0/20 [00:26<?, ?it/s, Prefill=293tok/s, Decode=68tok/s]Generating:   0%|          | 0/20 [00:26<?, ?it/s, Prefill=293tok/s, Decode=94tok/s]Generating:   0%|          | 0/20 [00:26<?, ?it/s, Prefill=293tok/s, Decode=108tok/s]Generating:   0%|          | 0/20 [00:27<?, ?it/s, Prefill=293tok/s, Decode=103tok/s]Generating:   0%|          | 0/20 [00:27<?, ?it/s, Prefill=293tok/s, Decode=68tok/s] Generating:   0%|          | 0/20 [00:27<?, ?it/s, Prefill=293tok/s, Decode=66tok/s]Generating:   0%|          | 0/20 [00:28<?, ?it/s, Prefill=293tok/s, Decode=66tok/s]Generating:   0%|          | 0/20 [00:28<?, ?it/s, Prefill=293tok/s, Decode=101tok/s]Generating:   0%|          | 0/20 [00:29<?, ?it/s, Prefill=293tok/s, Decode=58tok/s] Generating:   0%|          | 0/20 [00:29<?, ?it/s, Prefill=293tok/s, Decode=53tok/s]Generating:   0%|          | 0/20 [00:29<?, ?it/s, Prefill=293tok/s, Decode=112tok/s]Generating:   0%|          | 0/20 [00:30<?, ?it/s, Prefill=293tok/s, Decode=65tok/s] Generating:   0%|          | 0/20 [00:30<?, ?it/s, Prefill=293tok/s, Decode=54tok/s]Generating:   0%|          | 0/20 [00:31<?, ?it/s, Prefill=293tok/s, Decode=56tok/s]Generating:   0%|          | 0/20 [00:31<?, ?it/s, Prefill=293tok/s, Decode=59tok/s]Generating:   0%|          | 0/20 [00:31<?, ?it/s, Prefill=293tok/s, Decode=93tok/s]Generating:   0%|          | 0/20 [00:32<?, ?it/s, Prefill=293tok/s, Decode=60tok/s]Generating:   0%|          | 0/20 [00:32<?, ?it/s, Prefill=293tok/s, Decode=158tok/s]Generating:   0%|          | 0/20 [00:33<?, ?it/s, Prefill=293tok/s, Decode=149tok/s]Generating:   0%|          | 0/20 [00:33<?, ?it/s, Prefill=293tok/s, Decode=169tok/s]Generating:   0%|          | 0/20 [00:33<?, ?it/s, Prefill=293tok/s, Decode=148tok/s]Generating:   5%|▌         | 1/20 [00:33<10:44, 33.92s/it, Prefill=293tok/s, Decode=148tok/s]Generating:   5%|▌         | 1/20 [00:34<10:44, 33.92s/it, Prefill=293tok/s, Decode=54tok/s] Generating:   5%|▌         | 1/20 [00:34<10:44, 33.92s/it, Prefill=293tok/s, Decode=53tok/s]Generating:   5%|▌         | 1/20 [00:34<10:44, 33.92s/it, Prefill=293tok/s, Decode=113tok/s]Generating:   5%|▌         | 1/20 [00:35<10:44, 33.92s/it, Prefill=293tok/s, Decode=73tok/s] Generating:   5%|▌         | 1/20 [00:35<10:44, 33.92s/it, Prefill=293tok/s, Decode=67tok/s]Generating:   5%|▌         | 1/20 [00:35<10:44, 33.92s/it, Prefill=293tok/s, Decode=57tok/s]Generating:   5%|▌         | 1/20 [00:36<10:44, 33.92s/it, Prefill=293tok/s, Decode=107tok/s]Generating:   5%|▌         | 1/20 [00:36<10:44, 33.92s/it, Prefill=293tok/s, Decode=67tok/s] Generating:   5%|▌         | 1/20 [00:36<10:44, 33.92s/it, Prefill=293tok/s, Decode=57tok/s]Generating:   5%|▌         | 1/20 [00:37<10:44, 33.92s/it, Prefill=293tok/s, Decode=65tok/s]Generating:   5%|▌         | 1/20 [00:37<10:44, 33.92s/it, Prefill=293tok/s, Decode=54tok/s]Generating:   5%|▌         | 1/20 [00:37<10:44, 33.92s/it, Prefill=293tok/s, Decode=181tok/s]Generating:   5%|▌         | 1/20 [00:38<10:44, 33.92s/it, Prefill=293tok/s, Decode=50tok/s] Generating:   5%|▌         | 1/20 [00:38<10:44, 33.92s/it, Prefill=293tok/s, Decode=59tok/s]Generating:   5%|▌         | 1/20 [00:39<10:44, 33.92s/it, Prefill=293tok/s, Decode=50tok/s]Generating:   5%|▌         | 1/20 [00:39<10:44, 33.92s/it, Prefill=293tok/s, Decode=53tok/s]Generating:   5%|▌         | 1/20 [00:39<10:44, 33.92s/it, Prefill=293tok/s, Decode=115tok/s]Generating:   5%|▌         | 1/20 [00:40<10:44, 33.92s/it, Prefill=293tok/s, Decode=59tok/s] Generating:   5%|▌         | 1/20 [00:40<10:44, 33.92s/it, Prefill=293tok/s, Decode=107tok/s]Generating:   5%|▌         | 1/20 [00:40<10:44, 33.92s/it, Prefill=293tok/s, Decode=56tok/s] Generating:   5%|▌         | 1/20 [00:41<10:44, 33.92s/it, Prefill=293tok/s, Decode=75tok/s]Generating:   5%|▌         | 1/20 [00:41<10:44, 33.92s/it, Prefill=293tok/s, Decode=62tok/s]Generating:   5%|▌         | 1/20 [00:41<10:44, 33.92s/it, Prefill=293tok/s, Decode=89tok/s]Generating:   5%|▌         | 1/20 [00:42<10:44, 33.92s/it, Prefill=293tok/s, Decode=52tok/s]Generating:   5%|▌         | 1/20 [00:42<10:44, 33.92s/it, Prefill=293tok/s, Decode=103tok/s]Generating:   5%|▌         | 1/20 [00:42<10:44, 33.92s/it, Prefill=293tok/s, Decode=50tok/s] Generating:   5%|▌         | 1/20 [00:42<10:44, 33.92s/it, Prefill=293tok/s, Decode=123tok/s]Generating:   5%|▌         | 1/20 [00:43<10:44, 33.92s/it, Prefill=293tok/s, Decode=128tok/s]Generating:   5%|▌         | 1/20 [00:43<10:44, 33.92s/it, Prefill=293tok/s, Decode=56tok/s] Generating:   5%|▌         | 1/20 [00:43<10:44, 33.92s/it, Prefill=293tok/s, Decode=111tok/s]Generating:   5%|▌         | 1/20 [00:44<10:44, 33.92s/it, Prefill=293tok/s, Decode=57tok/s] Generating:   5%|▌         | 1/20 [00:44<10:44, 33.92s/it, Prefill=293tok/s, Decode=61tok/s]Generating:   5%|▌         | 1/20 [00:44<10:44, 33.92s/it, Prefill=293tok/s, Decode=69tok/s]Generating:   5%|▌         | 1/20 [00:45<10:44, 33.92s/it, Prefill=293tok/s, Decode=119tok/s]Generating:   5%|▌         | 1/20 [00:45<10:44, 33.92s/it, Prefill=293tok/s, Decode=61tok/s] Generating:   5%|▌         | 1/20 [00:45<10:44, 33.92s/it, Prefill=293tok/s, Decode=119tok/s]Generating:   5%|▌         | 1/20 [00:45<10:44, 33.92s/it, Prefill=293tok/s, Decode=61tok/s] Generating:   5%|▌         | 1/20 [00:46<10:44, 33.92s/it, Prefill=293tok/s, Decode=71tok/s]Generating:   5%|▌         | 1/20 [00:46<10:44, 33.92s/it, Prefill=293tok/s, Decode=93tok/s]Generating:   5%|▌         | 1/20 [00:47<10:44, 33.92s/it, Prefill=293tok/s, Decode=68tok/s]Generating:   5%|▌         | 1/20 [00:47<10:44, 33.92s/it, Prefill=293tok/s, Decode=60tok/s]Generating:   5%|▌         | 1/20 [00:47<10:44, 33.92s/it, Prefill=293tok/s, Decode=58tok/s]Generating:   5%|▌         | 1/20 [00:48<10:44, 33.92s/it, Prefill=293tok/s, Decode=150tok/s]Generating:   5%|▌         | 1/20 [00:48<10:44, 33.92s/it, Prefill=293tok/s, Decode=50tok/s] Generating:   5%|▌         | 1/20 [00:48<10:44, 33.92s/it, Prefill=293tok/s, Decode=50tok/s]Generating:   5%|▌         | 1/20 [00:48<10:44, 33.92s/it, Prefill=293tok/s, Decode=102tok/s]Generating:   5%|▌         | 1/20 [00:49<10:44, 33.92s/it, Prefill=293tok/s, Decode=54tok/s] Generating:   5%|▌         | 1/20 [00:49<10:44, 33.92s/it, Prefill=293tok/s, Decode=107tok/s]Generating:   5%|▌         | 1/20 [00:49<10:44, 33.92s/it, Prefill=293tok/s, Decode=57tok/s] Generating:   5%|▌         | 1/20 [00:50<10:44, 33.92s/it, Prefill=293tok/s, Decode=114tok/s]Generating:   5%|▌         | 1/20 [00:50<10:44, 33.92s/it, Prefill=293tok/s, Decode=57tok/s] Generating:   5%|▌         | 1/20 [00:50<10:44, 33.92s/it, Prefill=293tok/s, Decode=57tok/s]Generating:  10%|█         | 2/20 [00:50<07:10, 23.90s/it, Prefill=293tok/s, Decode=57tok/s]Generating:  10%|█         | 2/20 [00:51<07:10, 23.90s/it, Prefill=293tok/s, Decode=61tok/s]Generating:  10%|█         | 2/20 [00:51<07:10, 23.90s/it, Prefill=293tok/s, Decode=65tok/s]Generating:  10%|█         | 2/20 [00:51<07:10, 23.90s/it, Prefill=293tok/s, Decode=77tok/s]Generating:  10%|█         | 2/20 [00:52<07:10, 23.90s/it, Prefill=293tok/s, Decode=117tok/s]Generating:  10%|█         | 2/20 [00:52<07:10, 23.90s/it, Prefill=293tok/s, Decode=60tok/s] Generating:  10%|█         | 2/20 [00:52<07:10, 23.90s/it, Prefill=293tok/s, Decode=100tok/s]Generating:  10%|█         | 2/20 [00:53<07:10, 23.90s/it, Prefill=293tok/s, Decode=102tok/s][rank0]: Traceback (most recent call last):
[rank0]:   File "/data1/jyj/D2F/demo/test_dream_dvllm.py", line 85, in <module>
[rank0]:     outputs = llm.generate(prompts, sampling_params)
[rank0]:               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/engine/llm_engine.py", line 88, in generate
[rank0]:     output, num_tokens, is_prefill = self.step()
[rank0]:                                      ^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/engine/llm_engine.py", line 60, in step
[rank0]:     sample_output = self.model_runner.call("run", seqs, is_prefill)
[rank0]:                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/engine/model_runner.py", line 114, in call
[rank0]:     return method(*args)
[rank0]:            ^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/engine/model_runner.py", line 490, in run
[rank0]:     logits = self.run_model(input_ids, positions, is_prefill)
[rank0]:              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/utils/_contextlib.py", line 116, in decorate_context
[rank0]:     return func(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/engine/model_runner.py", line 470, in run_model
[rank0]:     return self.model.compute_logits(self.model(input_ids, positions))
[rank0]:                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
[rank0]:     return forward_call(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/models/dream.py", line 222, in forward
[rank0]:     hidden_states = self.model(input_ids, positions, mask)
[rank0]:                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
[rank0]:     return forward_call(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/models/dream.py", line 197, in forward
[rank0]:     hidden_states, residual = layer(positions, hidden_states, residual, mask)
[rank0]:                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
[rank0]:     return forward_call(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/models/dream.py", line 170, in forward
[rank0]:     hidden_states = self.self_attn(positions, hidden_states, mask)
[rank0]:                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
[rank0]:     return forward_call(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/models/dream.py", line 92, in forward
[rank0]:     o = self.attn(q, k, v, mask)
[rank0]:         ^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
[rank0]:     return forward_call(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/layers/attention/attention_v2_profile.py", line 338, in forward
[rank0]:     block_mask = self.dllm_block_mask(context.block_mask, B, H, Sq, Skv, str(q.device))
[rank0]:                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/d2f_vllm/layers/attention/attention_v2_profile.py", line 243, in dllm_block_mask
[rank0]:     self._block_mask_cache[cache_key] = create_block_mask(
[rank0]:                                         ^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/attention/flex_attention.py", line 888, in create_block_mask
[rank0]:     partial_block_mask, full_block_mask = _convert_mask_to_block_mask(
[rank0]:                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/nn/attention/flex_attention.py", line 691, in _convert_mask_to_block_mask
[rank0]:     mask_block_sum = mask.sum(
[rank0]:                      ^^^^^^^^^
[rank0]:   File "/data1/jyj/D2F/.venv/lib/python3.12/site-packages/torch/utils/_device.py", line 104, in __torch_function__
[rank0]:     return func(*args, **kwargs)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^
[rank0]: torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 1.81 GiB. GPU 0 has a total capacity of 23.65 GiB of which 773.81 MiB is free. Including non-PyTorch memory, this process has 22.89 GiB memory in use. Of the allocated memory 20.27 GiB is allocated by PyTorch, and 2.16 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
Generating:  10%|█         | 2/20 [00:53<08:04, 26.93s/it, Prefill=293tok/s, Decode=102tok/s]
